sudo: required

language: bash

services:
  - docker

before_install:
  - docker-compose -v

install:
  - docker-compose run --rm php composer install -n
  - docker-compose run --rm php ./vendor/bin/phpcs --standard=psr2 --ignore=vendor -n .
  - docker-compose run --rm -e AWS_ACCESS_KEY=$AWS_ODBC_KEY -e AWS_SECRET_KEY=$AWS_ODBC_SECRET php php driver/downloadDriver.php
  - docker-compose build app

script:
  - docker-compose run -e CODECLIMATE_REPO_TOKEN=$CODECLIMATE_REPO_TOKEN app

after_success:
  - docker images
  - echo Travis tag "$TRAVIS_TAG"
  - if [ -z "$TRAVIS_TAG" ]; then
        echo "Tag not set. Skipping deploy to Quay.";
    else
        docker login -u="$QUAY_USERNAME" -p="$QUAY_PASSWORD" quay.io;
        docker tag dbwritersnowflake_app quay.io/keboola/db-writer-snowflake:$TRAVIS_TAG;
        docker push quay.io/keboola/db-writer-snowflake:$TRAVIS_TAG;
    fi

#deploy:
#  provider: script
#  skip_cleanup: true
#  script: ./deploy.sh
#  on:
#    tags: true

#notifications:
#  slack: $SLACK_INTEGRATION_DOMAIN:$SLACK_INTEGRATION_KEY
